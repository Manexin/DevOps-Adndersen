---
- name: Test connection to my servers
  hosts: "{{ MYHOSTS }}"
  become: yes

  vars:
    user_app: flaskapp
    source_folder: /home/alex/MyRepo/DevOps-Adndersen/Ansible_assigment/ansible/flask_app
    dest_folder: /home/{{ user_app }}

  roles:
    - check_ping
    - { role: installing_software, when: ansible_system == 'Linux' }
    - conf_ufw

  tasks:

  - name: Added new user for app
    ansible.builtin.user:
      name: '{{ user_app }}'
      comment: User for app flask-emoji
      group: www-data
      groups: www-data, ssh
      state: present

#  - name: Create app folder
#    file: path={{ dest_folder }}/flask_app state=directory
  
  - name: Copy Flask-app to Web Server
    ansible.builtin.copy:
      scr: "{{ source_folder }}"
      dest: "{{ dest_folder }}"
      owner: "{{ user_app }}"
      mode: 0744
#    with_fileglob: "{{ source_folder }}"
    notify:
        - Restart Apache RedHat
        - Restart Apache Debian

  - name: Install `Flask`, `emoji`
    pip: name={{ item }} state=latest
    loop:
      - Flask
      - emoji

  handlers:
     - name: Restart Apache RedHat
       service: name=httpd state=restarted
       when: ansible_os_family == "RedHat"

     - name: Restart Apache Debian
       service: name=apache2 state=restarted
       when: ansible_os_family == "Debian"

